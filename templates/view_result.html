{% extends "base.html" %}
{# If you ever want to hide the global header for a cleaner sheet:
{% set hide_header = True %}
#}

{% block title %}View Result – {{ student.name }}{% endblock %}

{% block content %}
{# 
=====================================================================================
GOVT. BHS MAKHAMA — RESULT VIEW (ANDROID-STYLE, 500+ LINES, NO LEGEND BLOCK)
- Removed the colour “pattern/legend” information strip you didn’t want.
- Kept everything else: brand header, neat info lines, responsive table,
  division badge, print/share/compact buttons, etc.
- Ensured the Back button never sits under the bottom nav bar by adding extra
  bottom padding & a spacer.
=====================================================================================
#}

<style>
/* ============================================================================
   1) THEME TOKENS (light & dark are respected via data-bs-theme)
   ========================================================================== */
:root {
  --surface: #ffffff;
  --surface-alt: #f8f9fa;
  --on-surface: #212529;
  --muted: #6c757d;

  --primary: #0d6efd;
  --primary-soft: rgba(13,110,253,.12);

  --border: rgba(0,0,0,.1);

  --success: #198754;
  --warning: #ffc107;
  --danger: #dc3545;
  --info: #0dcaf0;

  --soft-shadow: 0 6px 18px rgba(0,0,0,.08);
  --soft-shadow-strong: 0 12px 28px rgba(0,0,0,.12);

  --radius: 18px;

  /* (We still keep row soft backgrounds if you want to retain them.
     If you want to remove them as well, set all to transparent) */
  --grade-low-bg: #f8d7da;
  --grade-med-bg: #fff3cd;
  --grade-good-bg: #d1ecf1;
  --grade-high-bg: #d4edda;

  --table-head-bg: #f1f1f1;
  --separator: rgba(0,0,0,.06);

  --brand: #0d6efd;

  /* safe-bottom height to keep stuff above bottom-nav (base.html) */
  --safe-bottom: 96px;
}

[data-bs-theme="dark"] {
  --surface: #1e1e1e;
  --surface-alt: #252525;
  --on-surface: #f1f1f1;
  --muted: #adb5bd;

  --border: rgba(255,255,255,.08);

  --soft-shadow: 0 6px 18px rgba(0,0,0,.28);
  --soft-shadow-strong: 0 12px 28px rgba(0,0,0,.34);

  --grade-low-bg: rgba(220,53,69,.18);
  --grade-med-bg: rgba(255,193,7,.14);
  --grade-good-bg: rgba(13,202,240,.14);
  --grade-high-bg: rgba(25,135,84,.18);

  --table-head-bg: #2b2b2b;
  --separator: rgba(255,255,255,.06);
}

/* ============================================================================
   2) WRAPPER
   ========================================================================== */
.result-wrap {
  padding-bottom: calc(var(--safe-bottom) + 24px); /* keep Back button well above menu */
}

/* ============================================================================
   3) CARD SHELL
   ========================================================================== */
.marks-card {
  background: var(--surface);
  color: var(--on-surface);
  border-radius: var(--radius);
  box-shadow: var(--soft-shadow);
  border: 1px solid var(--border);
  overflow: hidden;
  transform: translateY(8px);
  opacity: 0;
  animation: popIn .5s cubic-bezier(.2,.8,.2,1) forwards .08s;
}

@keyframes popIn {
  to { transform: translateY(0); opacity: 1; }
}

/* ============================================================================
   4) BRAND HEADER
   ========================================================================== */
.brand-header {
  text-align: center;
  font-weight: 800;
  font-size: 1.05rem;
  background: linear-gradient(135deg, var(--primary) 0%, #5b8cff 100%);
  color: #fff;
  padding: .9rem .75rem;
  letter-spacing: .2px;
}

/* ============================================================================
   5) INFO BLOCK
   ========================================================================== */
.info-block {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: .35rem .75rem;
  padding: .9rem .9rem .7rem;
  background: var(--surface);
  border-bottom: 1px dashed var(--separator);
}

.info-label {
  font-weight: 600;
  color: var(--muted);
  font-size: .84rem;
}

.info-value {
  font-weight: 700;
  color: var(--on-surface);
  font-size: .92rem;
}

.info-line {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
}

/* Stacked on small screens */
@media (max-width: 480px) {
  .info-line {
    flex-direction: column;
    align-items: flex-start;
  }
}

/* ============================================================================
   6) OVERALL RESULT BADGE
   ========================================================================== */
.overall-badge {
  display: inline-flex;
  align-items: center;
  gap: .4rem;
  padding: .25rem .6rem;
  border-radius: 999px;
  font-size: .8rem;
  font-weight: 600;
  margin-top: .3rem;
}
.overall-badge i { font-size: 1rem; }

.overall-badge.fail {
  background: rgba(220,53,69,.1);
  color: #dc3545;
}
[data-bs-theme="dark"] .overall-badge.fail {
  background: rgba(220,53,69,.22);
}
.overall-badge.third {
  background: rgba(255,193,7,.1);
  color: #ffc107;
}
[data-bs-theme="dark"] .overall-badge.third {
  background: rgba(255,193,7,.2);
}
.overall-badge.second {
  background: rgba(13,202,240,.08);
  color: #0dcaf0;
}
[data-bs-theme="dark"] .overall-badge.second {
  background: rgba(13,202,240,.16);
}
.overall-badge.first {
  background: rgba(25,135,84,.12);
  color: #198754;
}
[data-bs-theme="dark"] .overall-badge.first {
  background: rgba(25,135,84,.22);
}

/* ============================================================================
   7) ACTION STRIP
   ========================================================================== */
.action-strip {
  display: flex;
  flex-wrap: wrap;
  gap: .5rem;
  padding: .75rem .9rem .5rem;
  border-bottom: 1px dashed var(--separator);
  background: var(--surface-alt);
}
.action-strip .btn {
  border-radius: 999px;
}

/* Ripple effect for actions */
.ripple {
  position: relative;
  overflow: hidden;
}
.ripple span.r-ink {
  position: absolute;
  border-radius: 50%;
  transform: scale(0);
  animation: ripple .6s linear;
  background-color: rgba(255,255,255,.3);
}
@keyframes ripple {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

/* ============================================================================
   8) MARKS TABLE
   ========================================================================== */
.table-wrap {
  padding: .9rem;
}
.table-marks {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--soft-shadow);
  background: var(--surface);
}
.table-marks thead th {
  background: var(--table-head-bg);
  color: var(--on-surface);
  padding: .65rem .5rem;
  text-align: center;
  border-bottom: 1px solid var(--border);
  font-size: .9rem;
  font-weight: 600;
}
.table-marks tbody td {
  text-align: center;
  padding: .6rem .4rem;
  border-bottom: 1px solid var(--border);
}
.table-marks tbody tr:last-child td {
  border-bottom: none;
}

/* We keep these only if you still like row soft colors; 
   If you want them gone too, simply comment them out and remove 
   the row classes in template. Since you asked only to remove the 
   “pattern information above”, we keep these slight cues. */
.grade-low  { background-color: var(--grade-low-bg);  }
.grade-med  { background-color: var(--grade-med-bg);  }
.grade-good { background-color: var(--grade-good-bg); }
.grade-high { background-color: var(--grade-high-bg); }

/* Total row */
.total-row {
  background: var(--surface-alt);
  font-weight: 700;
}

/* ============================================================================
   9) FOOT NOTES / SIGNATURES
   ========================================================================== */
.footer-notes {
  padding: .4rem .9rem 1rem;
  font-size: .82rem;
  color: var(--muted);
}
.signatures {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 1.2rem;
  margin-top: 1rem;
}
.sig-box {
  text-align: center;
  border-top: 1px solid var(--border);
  padding-top: .4rem;
  font-weight: 500;
}

/* ============================================================================
   10) BACK BUTTON SECTION
   ========================================================================== */
.back-section {
  margin-top: 1.25rem;
  margin-bottom: 1rem;
  position: relative;
  z-index: 2; /* keep well above anything else */
}
.back-section .btn {
  border-radius: 999px;
}

/* ============================================================================
   11) PRINT
   Hide header, bottom nav etc when printing.
   ========================================================================== */
@media print {
  .app-header,
  .bottom-nav,
  .flash-stack,
  .action-strip,
  .back-section { display: none !important; }

  main.container {
    padding: 0 !important;
  }

  .marks-card {
    box-shadow: none !important;
    border: 1px solid #000 !important;
    border-radius: 0 !important;
  }

  body {
    background: #fff !important;
  }
}
</style>

<div class="result-wrap container py-3">

  <!-- =======================================================================
       MARKS CARD (MAIN)
       ===================================================================== -->
  <div class="marks-card" id="marksCard">

    <!-- =================== BRAND HEADER =================== -->
    <div class="brand-header">
      Govt. BHS Makhama
    </div>

    <!-- =================== INFO BLOCK ===================== -->
    <div class="info-block" aria-label="Student and exam information">
      <div class="info-line">
        <span class="info-label">Name:</span>
        <span class="info-value">{{ student.name }}</span>
      </div>

      <div class="info-line">
        <span class="info-label">Roll Number:</span>
        <span class="info-value">{{ student.roll_number }}</span>
      </div>

      <div class="info-line">
        <span class="info-label">Class:</span>
        <span class="info-value">{{ exam.class }}</span>
      </div>

      <div class="info-line">
        <span class="info-label">Exam Date:</span>
        <span class="info-value">{{ exam.exam_date }}</span>
      </div>

      <div class="info-line">
        <span class="info-label">Exam Name:</span>
        <span class="info-value">{{ exam.exam_name }}</span>
      </div>

      <div class="info-line">
        <span class="info-label">Percentage:</span>
        <span class="info-value">
          {{ "%.2f"|format(student.percentage) }}%
          {% set badge_class = (
            'fail'   if student.percentage < 33 else
            'third'  if student.percentage < 50 else
            'second' if student.percentage < 75 else
            'first'
          ) %}
          <span class="overall-badge {{ badge_class }}" aria-label="Overall Result Status">
            {% if badge_class == 'fail' %}
              <i class="bi bi-x-circle"></i> Fail
            {% elif badge_class == 'third' %}
              <i class="bi bi-exclamation-circle"></i> Third Division
            {% elif badge_class == 'second' %}
              <i class="bi bi-check-circle"></i> Second Division
            {% else %}
              <i class="bi bi-trophy"></i> First Division
            {% endif %}
          </span>
        </span>
      </div>
    </div>

    <!-- =================== ACTION STRIP =================== -->
    <div class="action-strip">
      <button class="btn btn-primary btn-sm ripple" id="btnPrint" type="button">
        <i class="bi bi-printer-fill me-1"></i> Print / Download
      </button>

      <button class="btn btn-outline-secondary btn-sm ripple" id="btnShare" type="button">
        <i class="bi bi-share me-1"></i> Share
      </button>

      <button class="btn btn-outline-info btn-sm ripple ms-auto" id="btnCompact" type="button" aria-pressed="false">
        <i class="bi bi-arrows-collapse me-1"></i> Compact view
      </button>
    </div>

    <!-- =================== MARKS TABLE ==================== -->
    <div class="table-wrap">
      <div class="table-responsive">
        <table class="table-marks" role="table" aria-label="Marks table">
          <thead>
            <tr>
              <th scope="col">Subject</th>
              <th scope="col">Marks Obtained</th>
              <th scope="col">Total Marks</th>
            </tr>
          </thead>
          <tbody>
          {# NOTE: You said not to show per-subject percentage, so we don't. #}
          {% for subject in student.subjects %}
            {% set pc = (subject.marks_obtained / subject.total_marks * 100) %}
            {% set color_row = (
              'grade-low' if pc < 33 else
              'grade-med' if pc < 50 else
              'grade-good' if pc < 75 else
              'grade-high'
            ) %}
            <tr class="{{ color_row }}">
              <td>{{ subject.subject }}</td>
              <td>{{ subject.marks_obtained }}</td>
              <td>{{ subject.total_marks }}</td>
            </tr>
          {% endfor %}
            <tr class="total-row">
              <td>Total</td>
              <td>{{ student.total_obtained }}</td>
              <td>{{ student.total_max }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- =================== FOOT NOTES & SIGNATURES ========= -->
    <div class="footer-notes">
      <em>Note:</em> This is a computer-generated result and does not require a physical signature.  
      Please verify any discrepancy with the school administration.
      <div class="signatures">
        <div class="sig-box">Class Teacher</div>
        <div class="sig-box">Vice Principal</div>
        <div class="sig-box">Principal</div>
      </div>
    </div>
  </div>

  <!-- Safe space to keep the button from overlapping the bottom nav -->
  <div class="back-section">
    <a href="{{ url_for('results') }}" class="btn btn-outline-primary w-100">
      <i class="bi bi-arrow-left"></i> Back to Results
    </a>
  </div>
</div>

<script>
/* =============================================================================
   JS BEHAVIOR (print / share / compact / ripple)
   ========================================================================== */
document.addEventListener('DOMContentLoaded', function() {
  const btnPrint   = document.getElementById('btnPrint');
  const btnShare   = document.getElementById('btnShare');
  const btnCompact = document.getElementById('btnCompact');
  const marksCard  = document.getElementById('marksCard');

  // ------------------ 1) Print / Download ------------------
  btnPrint?.addEventListener('click', () => {
    window.print();
  });

  // ------------------ 2) Share ------------------
  btnShare?.addEventListener('click', async () => {
    try {
      const shareData = {
        title: document.title || 'Result',
        text: 'Here is my result from Govt. BHS Makhama.',
        url: window.location.href
      };
      if (navigator.share) {
        await navigator.share(shareData);
      } else {
        await navigator.clipboard.writeText(window.location.href);
        alert('Link copied to clipboard!');
      }
    } catch (err) {
      console.error('Share failed:', err);
    }
  });

  // ------------------ 3) Compact View ------------------
  btnCompact?.addEventListener('click', () => {
    const isPressed = btnCompact.getAttribute('aria-pressed') === 'true';
    btnCompact.setAttribute('aria-pressed', String(!isPressed));
    marksCard.classList.toggle('compact');
    btnCompact.innerHTML = !isPressed 
      ? '<i class="bi bi-arrows-expand me-1"></i> Normal view'
      : '<i class="bi bi-arrows-collapse me-1"></i> Compact view';
  });

  // ------------------ 4) Ripple ------------------
  document.addEventListener('click', function(e){
    const target = e.target.closest('.ripple');
    if(!target) return;

    const rect = target.getBoundingClientRect();
    const ink = document.createElement('span');
    ink.classList.add('r-ink');
    ink.style.left = (e.clientX - rect.left) + 'px';
    ink.style.top  = (e.clientY - rect.top)  + 'px';
    ink.style.width = ink.style.height = Math.max(rect.width, rect.height) + 'px';

    target.appendChild(ink);
    setTimeout(()=> ink.remove(), 600);
  }, false);
});
</script>
{% endblock %}
