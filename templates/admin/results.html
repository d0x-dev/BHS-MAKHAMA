{% extends "base.html" %}
{% set hide_header = True %}

{% block title %}Manage Results – Admin{% endblock %}

{% block content %}
<style>
  :root {
    --ripple-color: rgba(255,255,255,.35);
    --card-radius: 16px;
    --soft-shadow: 0 6px 16px rgba(0,0,0,.08);
    --soft-shadow-dark: 0 6px 16px rgba(0,0,0,.25);
  }

  body {
    background-color: var(--bs-body-bg);
    font-family: 'Roboto', sans-serif;
  }

  /* Android-like page title */
  .page-title {
    font-weight: 700;
    font-size: 1.4rem;
    letter-spacing: .3px;
    text-align: center;
    margin-top: 0.5rem;
    margin-bottom: 1.2rem;
  }

  /* Wrapper */
  .results-wrapper {
    padding-bottom: 100px;
  }

  /* Glassy Material card */
  .glass-card {
    border: none;
    border-radius: var(--card-radius);
    box-shadow: var(--soft-shadow);
    overflow: hidden;
    background: var(--bs-card-bg);
    margin-bottom: 1.2rem;
    transform: translateY(5px);
    opacity: 0;
    animation: popIn .4s ease-out forwards .05s;
  }
  @keyframes popIn { to { transform: translateY(0); opacity: 1; } }

  /* Card headers */
  .card-header {
    padding: .9rem 1rem;
    font-size: 1rem;
    font-weight: 600;
    background: linear-gradient(135deg,#0d6efd 0%,#4e87ff 100%);
    color: #fff;
  }
  .card-header-info {
    background: linear-gradient(135deg,#0dcaf0 0%,#17a2b8 100%);
  }

  /* Inputs */
  .form-control, .form-select {
    min-height: 46px;
    font-size: 1rem;
    border-radius: 12px;
    padding-left: .9rem;
  }
  .form-label {
    font-weight: 500;
    font-size: .9rem;
    margin-bottom: .35rem;
  }

  /* Subject pill rows */
  .subject-pill {
    background: var(--bs-tertiary-bg);
    border-radius: 14px;
    padding: .8rem .8rem .6rem;
    box-shadow: 0 2px 6px rgba(0,0,0,.05);
    position: relative;
  }
  .subject-pill .remove-subject {
    position: absolute;
    top: 7px;
    right: 7px;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: grid;
    place-items: center;
    background: #e74c3c;
    color: #fff;
    font-size: .8rem;
  }

  /* Add Subject Floating Button */
  .fab-add {
    position: fixed;
    right: 16px;
    bottom: 95px;
    width: 58px;
    height: 58px;
    border-radius: 50%;
    box-shadow: 0 4px 10px rgba(0,0,0,.25);
    z-index: 1025;
    background-color: #0d6efd;
    color: #fff;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .fab-add:active {
    transform: scale(.96);
  }

  /* Desktop Add button */
  .add-desktop {
    display: none;
  }
  @media (min-width:768px) {
    .add-desktop {
      display: inline-block;
      margin-top: 10px;
    }
    .fab-add {
      display: none;
    }
  }

  /* Save button */
  .btn-lg {
    border-radius: 14px;
    font-size: 1.05rem;
    font-weight: 600;
    padding: 0.75rem;
  }

  /* Divider */
  .divider {
    height: 1px;
    background: rgba(0,0,0,.08);
    margin: 1rem 0;
  }

  /* Accordion (Existing results) */
  .accordion-button {
    font-weight: 600;
    padding: 0.9rem 1rem;
    border-radius: 12px;
  }
  .result-badge {
    background: rgba(13,110,253,.1);
    color: #0d6efd;
    padding: .2rem .55rem;
    border-radius: 999px;
    font-size: .75rem;
  }

  /* Dark Mode */
  [data-bs-theme="dark"] .glass-card { background: #1e1e1e; box-shadow: var(--soft-shadow-dark); }
  [data-bs-theme="dark"] .subject-pill { background:#2a2a2a; }
  [data-bs-theme="dark"] .divider { background:rgba(255,255,255,.1); }

  /* Bottom nav */
  #bottomMenu {
    background-color: var(--bs-body-bg);
    border-top: 1px solid var(--bs-border-color);
    padding: .25rem 0;
  }
  .nav-link {
    font-size: .8rem;
    color: var(--bs-body-color);
  }
</style>

<div class="container results-wrapper mt-3">
  <h2 class="page-title">Manage Results</h2>

  <!-- ADD/EDIT RESULTS -->
  <div class="glass-card">
    <div class="card-header">
      <i class="bi bi-ui-checks-grid me-2"></i> Add / Edit Results
    </div>
    <div class="card-body p-3">
      <form method="POST" id="resultForm" autocomplete="off">
        <!-- Student meta -->
        <div class="mb-3">
          <label class="form-label">Student Name</label>
          <input type="text" name="name" class="form-control" required placeholder="e.g. Ahmed Khan">
        </div>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label">Class</label>
            <input type="text" name="class" class="form-control" required placeholder="e.g. 10th">
          </div>
          <div class="col-6">
            <label class="form-label">Roll Number</label>
            <input type="text" name="roll_number" class="form-control" required placeholder="e.g. 25">
          </div>
        </div>

        <div class="divider"></div>

        <!-- Subjects -->
        <label class="form-label fw-bold mb-2"><i class="bi bi-journal-text me-1"></i> Subjects & Marks</label>
        <div id="subjectsContainer" class="d-flex flex-column gap-2">
          <!-- Subject row -->
          <div class="subject-pill">
            <button type="button" class="remove-subject" disabled><i class="bi bi-x-lg"></i></button>
            <div class="row g-2">
              <div class="col-12">
                <label class="form-label small">Subject</label>
                <input type="text" name="subject_name_0" class="form-control" required placeholder="e.g. Mathematics">
              </div>
              <div class="col-6">
                <label class="form-label small">Marks Obtained</label>
                <input type="number" name="marks_obtained_0" class="form-control" required placeholder="e.g. 78">
              </div>
              <div class="col-6">
                <label class="form-label small">Total Marks</label>
                <input type="number" name="total_marks_0" class="form-control" required placeholder="e.g. 100">
              </div>
            </div>
          </div>
        </div>

        <!-- Add buttons -->
        <button type="button" id="addSubject" class="fab-add ripple"><i class="bi bi-plus-lg"></i></button>
        <button type="button" id="addSubjectDesktop" class="btn btn-outline-primary add-desktop ripple"><i class="bi bi-plus-circle"></i> Add Subject</button>

        <div class="divider"></div>

        <!-- Save -->
        <button type="submit" class="btn btn-success btn-lg w-100 ripple"><i class="bi bi-save2 me-1"></i> Save Results</button>
      </form>
    </div>
  </div>

  <!-- Existing Results -->
  <div class="glass-card">
    <div class="card-header card-header-info">
      <i class="bi bi-collection me-2"></i> Existing Results
    </div>
    <div class="card-body p-3">
      {% if results %}
        <div class="accordion" id="resultsAccordion">
          {% for result in results %}
          {% set rid = 'res_' ~ loop.index %}
          <div class="accordion-item mb-2 border-0">
            <h2 class="accordion-header" id="h-{{ rid }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c-{{ rid }}">
                <div>
                  <span class="fw-semibold">{{ result.name }} <span class="result-badge">Class {{ result.class }}</span></span><br>
                  <small class="text-muted">Roll {{ result.roll_number }} • {{ result.date.split()[0] }}</small>
                </div>
              </button>
            </h2>
            <div id="c-{{ rid }}" class="accordion-collapse collapse">
              <div class="accordion-body">
                <ul class="list-group list-group-flush">
                  {% for sub in result.subjects %}
                  <li class="list-group-item d-flex justify-content-between">
                    <span>{{ sub.subject }}</span>
                    <span class="fw-bold">{{ sub.marks_obtained }}/{{ sub.total_marks }}</span>
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-4">
          <i class="bi bi-clipboard-x fs-1 text-muted"></i>
          <p class="text-muted mb-0">No results found</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<nav class="navbar navbar-expand fixed-bottom shadow-sm" id="bottomMenu">
  <div class="container justify-content-around">
    <a class="nav-link text-center" href="{{ url_for('admin_dashboard') }}">
      <i class="bi bi-speedometer2 fs-5"></i><br>Dashboard
    </a>
    <a class="nav-link text-center" href="{{ url_for('change_password') }}">
      <i class="bi bi-key fs-5"></i><br>Password
    </a>
    <a class="nav-link text-center" href="{{ url_for('admin_logout') }}">
      <i class="bi bi-box-arrow-right fs-5"></i><br>Logout
    </a>
  </div>
</nav>

<!-- JS -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  let subjectCount = 1;
  const container = document.getElementById('subjectsContainer');
  const addSubjectFab = document.getElementById('addSubject');
  const addSubjectDesktop = document.getElementById('addSubjectDesktop');

  function addSubject() {
    const wrap = document.createElement('div');
    wrap.className = 'subject-pill';
    wrap.innerHTML = `
      <button type="button" class="remove-subject"><i class="bi bi-x-lg"></i></button>
      <div class="row g-2">
        <div class="col-12">
          <label class="form-label small">Subject</label>
          <input type="text" name="subject_name_${subjectCount}" class="form-control" required placeholder="e.g. Science">
        </div>
        <div class="col-6">
          <label class="form-label small">Marks Obtained</label>
          <input type="number" name="marks_obtained_${subjectCount}" class="form-control" required placeholder="e.g. 72">
        </div>
        <div class="col-6">
          <label class="form-label small">Total Marks</label>
          <input type="number" name="total_marks_${subjectCount}" class="form-control" required placeholder="e.g. 100">
        </div>
      </div>
    `;
    container.appendChild(wrap);
    subjectCount++;
  }

  addSubjectFab.addEventListener('click', addSubject);
  addSubjectDesktop.addEventListener('click', addSubject);

  document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-subject')) {
      e.target.closest('.subject-pill').remove();
    }
  });
});
</script>
{% endblock %}
